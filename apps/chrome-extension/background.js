// FormSync - Background Service Worker
class FormSyncBackground {
  constructor() {
    this.init();
  }

  init() {
    this.setupEventListeners();
    console.log('FormSync: Background service worker inicializado');
  }

  setupEventListeners() {
    // Listener para instala√ß√£o da extens√£o
    chrome.runtime.onInstalled.addListener((details) => {
      this.onExtensionInstalled(details);
    });

    // Listener para mensagens do popup ou content scripts
    chrome.runtime.onMessage.addListener((request, sender, sendResponse) => {
      this.handleMessage(request, sender, sendResponse);
      return true; // Indica que a resposta ser√° ass√≠ncrona
    });

    // Listener para mudan√ßas de abas
    chrome.tabs.onUpdated.addListener((tabId, changeInfo, tab) => {
      this.onTabUpdated(tabId, changeInfo, tab);
    });

    // Listener para mudan√ßas de abas ativas
    chrome.tabs.onActivated.addListener((activeInfo) => {
      this.onTabActivated(activeInfo);
    });
  }

  onExtensionInstalled(details) {
    console.log('FormSync: Extens√£o instalada/atualizada:', details);
    
    if (details.reason === 'install') {
      // Primeira instala√ß√£o
      this.showWelcomePage();
    } else if (details.reason === 'update') {
      // Atualiza√ß√£o
      console.log('FormSync: Extens√£o atualizada para vers√£o', chrome.runtime.getManifest().version);
    }
  }

  showWelcomePage() {
    // Abre a p√°gina de boas-vindas na primeira instala√ß√£o
    chrome.tabs.create({
      url: 'https://formsync.netlify.app/welcome'
    });
  }

  async handleMessage(request, sender, sendResponse) {
    try {
      console.log('FormSync: Mensagem recebida no background:', request);
      
      switch (request.action) {
        case 'getTemplates':
          const templates = await this.getTemplates();
          sendResponse({ success: true, templates });
          break;
          
        case 'saveTemplate':
          const result = await this.saveTemplate(request.template);
          sendResponse({ success: true, result });
          break;
          
        case 'recordUsage':
          await this.recordTemplateUsage(request.templateId, request.success);
          sendResponse({ success: true });
          break;
          
        case 'ping':
          sendResponse({ success: true, message: 'FormSync est√° funcionando!' });
          break;
          
        case 'template_created':
        case 'template_updated':
        case 'template_deleted':
          // Notifica√ß√£o do frontend sobre mudan√ßas nos templates
          console.log('FormSync: Notifica√ß√£o de template recebida:', request);
          await this.handleTemplateNotification(request);
          sendResponse({ success: true, message: 'Notifica√ß√£o processada' });
          break;
          
        default:
          sendResponse({ success: false, error: 'A√ß√£o n√£o reconhecida' });
      }
    } catch (error) {
      console.error('FormSync: Erro ao processar mensagem:', error);
      sendResponse({ success: false, error: error.message });
    }
  }

  async getTemplates() {
    try {
      console.log('FormSync: Carregando templates no background...');
      
      // Carrega templates do usu√°rio espec√≠fico (usuarioId=6) da API
      const baseUrl = 'https://backend-production-0914.up.railway.app';
      
      // Buscar Formul√°rios do usu√°rio espec√≠fico
      const response = await fetch(`${baseUrl}/api/v1/public/templates?usuarioId=6`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
          'X-Extension-Key': 'ext_2024_preenche_rapido_secure_key_987654321'
        }
      });

      if (response.ok) {
        const data = await response.json();
        console.log('FormSync: Templates carregados no background:', data);
        return data || [];
      } else {
        console.error('FormSync: Erro ao carregar templates no background:', response.status);
        return [];
      }
    } catch (error) {
      console.error('FormSync: Erro ao carregar templates no background:', error);
      return [];
    }
  }

  async saveTemplate(template) {
    try {
      // Salva template real no backend usando API p√∫blica
      const baseUrl = 'https://backend-production-0914.up.railway.app';
      const url = `${baseUrl}/api/v1/public/templates`;
      
      const response = await fetch(url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-Extension-Key': 'ext_2024_preenche_rapido_secure_key_987654321'
        },
        body: JSON.stringify(template)
      });

      if (response.ok) {
        const savedTemplate = await response.json();
        console.log('FormSync: Template salvo com sucesso:', savedTemplate);
        return savedTemplate;
      } else {
        console.error('FormSync: Erro ao salvar template:', response.status);
        throw new Error(`Erro ${response.status}: ${response.statusText}`);
      }
    } catch (error) {
      console.error('FormSync: Erro ao salvar template:', error);
      throw error;
    }
  }

  async recordTemplateUsage(templateId, success) {
    try {
      // Registra o uso do template no backend usando API p√∫blica
      const baseUrl = 'https://backend-production-0914.up.railway.app';
      const response = await fetch(`${baseUrl}/api/v1/public/templates/${templateId}/uso`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-Extension-Key': 'ext_2024_preenche_rapido_secure_key_987654321'
        },
        body: JSON.stringify({ success })
      });

      if (response.ok) {
        console.log(`FormSync: Uso do template ${templateId} registrado com sucesso`);
      } else {
        console.error('FormSync: Erro ao registrar uso do template:', response.status);
      }
    } catch (error) {
      console.error('FormSync: Erro ao registrar uso do template:', error);
    }
  }

  onTabUpdated(tabId, changeInfo, tab) {
    // Monitora mudan√ßas nas abas para detectar formul√°rios
    if (changeInfo.status === 'complete' && tab.url) {
      this.analyzePageForForms(tabId, tab.url);
    }
  }

  onTabActivated(activeInfo) {
    // Atualiza o contexto quando uma nova aba √© ativada
    console.log('FormSync: Nova aba ativada:', activeInfo.tabId);
  }

  async analyzePageForForms(tabId, url) {
    try {
      // Verifica se a p√°gina pode conter formul√°rios
      if (this.isFormPage(url)) {
        console.log('FormSync: P√°gina de formul√°rio detectada:', url);
        
        // Pode enviar mensagem para o content script para an√°lise adicional
        // chrome.tabs.sendMessage(tabId, { action: 'analyzePage' });
      }
    } catch (error) {
      console.error('FormSync: Erro ao analisar p√°gina:', error);
    }
  }

  isFormPage(url) {
    // Lista de padr√µes de URL que podem conter formul√°rios
    const formPatterns = [
      /login/i,
      /signin/i,
      /register/i,
      /signup/i,
      /apply/i,
      /candidate/i,
      /job/i,
      /career/i,
      /form/i,
      /submit/i
    ];
    
    return formPatterns.some(pattern => pattern.test(url));
  }

  // M√©todo para sincronizar com o backend (futuro)
  async syncWithBackend() {
    try {
      // Futuramente ser√° implementado para sincronizar templates
      // com o backend em tempo real
      console.log('FormSync: Sincroniza√ß√£o com backend (n√£o implementada ainda)');
    } catch (error) {
      console.error('FormSync: Erro na sincroniza√ß√£o:', error);
    }
  }

  /**
   * Processa notifica√ß√µes de templates do frontend
   */
  async handleTemplateNotification(notification) {
    try {
      console.log('FormSync: Processando notifica√ß√£o de template:', notification);
      
      switch (notification.action) {
        case 'template_created':
          console.log(`üÜï Novo Formul√°rio criado: ${notification.templateName} (ID: ${notification.templateId})`);
          // Limpar cache local para for√ßar recarregamento
          await this.clearTemplateCache();
          break;
          
        case 'template_updated':
          console.log(`‚úèÔ∏è Template atualizado: ${notification.templateName} (ID: ${notification.templateId})`);
          await this.clearTemplateCache();
          break;
          
        case 'template_deleted':
          console.log(`üóëÔ∏è Template deletado: ${notification.templateName} (ID: ${notification.templateId})`);
          await this.clearTemplateCache();
          break;
          
        default:
          console.log('FormSync: A√ß√£o de template n√£o reconhecida:', notification.action);
      }
      
      // Notificar todas as abas ativas sobre a mudan√ßa
      await this.notifyAllTabs(notification);
      
    } catch (error) {
      console.error('FormSync: Erro ao processar notifica√ß√£o de template:', error);
    }
  }

  /**
   * Limpa cache local de templates
   */
  async clearTemplateCache() {
    try {
      // Limpar cache do chrome.storage se dispon√≠vel
      if (chrome.storage && chrome.storage.local) {
        await chrome.storage.local.remove(['templates', 'templates_cache']);
        console.log('FormSync: Cache de templates limpo');
      }
    } catch (error) {
      console.error('FormSync: Erro ao limpar cache:', error);
    }
  }

  /**
   * Notifica todas as abas ativas sobre mudan√ßas nos templates
   */
  async notifyAllTabs(notification) {
    try {
      const tabs = await chrome.tabs.query({ active: true });
      
      for (const tab of tabs) {
        try {
          await chrome.tabs.sendMessage(tab.id, {
            action: 'template_updated',
            notification: notification
          });
          console.log(`FormSync: Aba ${tab.id} notificada sobre mudan√ßa de template`);
        } catch (error) {
          // Ignora erros de abas que n√£o t√™m content script
          console.log(`FormSync: Aba ${tab.id} n√£o p√¥de ser notificada:`, error.message);
        }
      }
    } catch (error) {
      console.error('FormSync: Erro ao notificar abas:', error);
    }
  }
}

// Inicializa o background service worker
const formSyncBackground = new FormSyncBackground();

// Mant√©m o service worker ativo
chrome.runtime.onStartup.addListener(() => {
  console.log('FormSync: Service worker iniciado');
});

// Listener para manter o service worker ativo
chrome.runtime.onSuspend.addListener(() => {
  console.log('FormSync: Service worker suspenso');
});
